package com.example.demo.service;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.temporal.TemporalAdjusters;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.example.demo.entity.Account;
import com.example.demo.repository.jpa.AccountRepository;

@Service
public class LikeService {

    @Autowired
    private AccountRepository accountRepository;

    // アカウントのいいね数を1増加させる
    public int likeAccount(Long accountId) {
        Account account = accountRepository.findById(accountId).orElse(null);
        if (account != null) {
            int currentLikes = account.getLikes();
            account.setLikes(currentLikes + 1);
            accountRepository.save(account);
            System.out.println("Updated likes for account ID: " + accountId + " to " + (currentLikes + 1));
            return account.getLikes(); // 更新後のいいね数を返す
        } else {
            throw new RuntimeException("Account not found with ID: " + accountId);
        }
    }

    // 月ごとのいいねランキング
    public List<Account> findTopLikedAccountsForMonth(LocalDateTime startOfMonth, LocalDateTime endOfMonth) {
        return accountRepository.findTopLikedAccountsForMonth(startOfMonth, endOfMonth);
    }

    // 年間のいいねランキング
    public List<Account> findTopLikedAccountsForPeriod(LocalDateTime startOfYear, LocalDateTime endOfYear) {
        return accountRepository.findTopLikedAccountsForPeriod(startOfYear, endOfYear);
    }
    public int getLikesForYear(Long userId, int year) {
        LocalDateTime startOfYear = LocalDate.of(year, 1, 1).atStartOfDay();
        LocalDateTime endOfYear = LocalDate.of(year, 12, 31).atTime(23, 59, 59);
        List<Account> accounts = accountRepository.findLikesByUserAndPeriod(userId, startOfYear, endOfYear);
        return accounts.stream().mapToInt(Account::getLikes).sum();
    }

    public int getLikesForMonth(Long userId, int year, int month) {
        LocalDateTime startOfMonth = LocalDate.of(year, month, 1).atStartOfDay();
        LocalDateTime endOfMonth = startOfMonth.with(TemporalAdjusters.lastDayOfMonth()).atTime(23, 59, 59);
        List<Account> accounts = accountRepository.findLikesByUserAndPeriod(userId, startOfMonth, endOfMonth);
        return accounts.stream().mapToInt(Account::getLikes).sum();
    }
}
